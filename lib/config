#!/bin/bash

SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
LIB_DIR="/usr/share/downganizer/lib"

PROD=false

if [[ "$PROD" = false ]]; then
    LIB_DIR="$SCRIPT_DIR/lib"
fi

source "$LIB_DIR/theme"


dg_config (){
    if [[ $# -eq 0 ]]; then
        config
    fi

    if [[ $1 == "help" ]]; then
        config_help
    fi

    while [[ $# -ne 0 ]]; do
        if [[ $# -lt 2 ]]; then
            invalid_config;
        fi
        case $1 in
            "criteria") shift; 
                if [[ $1 == "month" || $1 == "type" ]]; then
                    set_criteria $1
                else
                    invalid_config
                fi
            ;;
            "nested") shift; 
                if [[ $1 == "type" || $1 == "month" || $1 == "false" ]]; then
                    set_nested $1
                else
                    invalid_config
                fi
            ;;
            "duplicates") shift;
                if [[ $1 == "overwrite" || $1 == "rename" ]]; then
                    set_dups  $1;
                else
                    invalid_config
                fi
            ;;
            *) invalid_config ;;
        esac
        shift;
    done

}

invalid_config() {
    echo -e "$RED""Invalid configuration data. Please refer to the documentation.$REGULAR";
    echo -e "Or try running $BOLD$0 config help$REGULAR"
    exit 1;
}

config_help() {
    echo "Hello"
    exit 0
}

config() {
    crites=$(cat /etc/downganizer/options.conf | grep -m 1 "CRITERIAS=" | cut -d '=' -f2 )
    crites=$(echo $crites | sed 's/\[//' | sed 's/\]//')
    crites=($crites)
    crites+=("somethign")
    echo "crites: ${crites[@]}"
    echo "count as: ${#crites[@]}"
}

select_option() {
    local ques="$1"
    shift;
    local options=("$@")
    local selected=0

    echo "$ques"
    while true; do
        ops=""
        for i in "${!options[@]}"; do
            if [ $i -eq $selected ]; then
                ops+="$GREEN${options[$i]}$WHITE | "
            else
                ops+="${options[$i]} | "
            fi
        done
        
        echo -e "${ops::-3}\r"
        
        read -rsn1 input
        if [[ $input == $'\x1b' ]]; then
            read -rsn2 input
            if [[ $input == '[D' ]]; then
                selected=$(( (selected - 1 + ${#options[@]}) % ${#options[@]} ))
            elif [[ $input == '[C' ]]; then
                selected=$(( (selected + 1) % ${#options[@]} ))
            fi
        elif [[ $input == "" ]]; then
            return $selected
        fi

        echo -ne "\033[1A\033[2K"
    done
}

# Individual config functions

set_criteria(){
    criteria=$(cat ~/.config/downganizer.conf | grep -m 1 "CRITERIA=" | cut -d '=' -f2)
    if [[ $1 == "$criteria" ]]; then
        return;
    fi

    nested=$(cat ~/.config/downganizer.conf | grep -m 1 "NESTED_CRITERIA=" | cut -d '=' -f2)
    if [[ "$nested" == "$1" ]]; then
        sed -i 's/NESTED=true/NESTED=false/' ~/.config/downganizer.conf
        sed -i "s/NESTED_CRITERIA=$nested/NESTED_CRITERIA=null/" ~/.config/downganizer.conf
    fi

    sed -i "s/CRITERIA=$criteria/CRITERIA=$1/" ~/.config/downganizer.conf
}

set_nested(){
    nested=$(cat ~/.config/downganizer.conf | grep -m 1 "NESTED_CRITERIA=" | cut -d '=' -f2)
    isNested=$(cat ~/.config/downganizer.conf | grep -m 1 "NESTED=" | cut -d '=' -f2)
    if [[ "$nested" == "$1" || "$1" == "$isNested" ]]; then
        return;
    fi

    criteria=$(cat ~/.config/downganizer.conf | grep -m 1 "CRITERIA=" | cut -d '=' -f2)
    if [[ "$1" == "$criteria" ]]; then 
        echo -e "$RED""You can't set secondary criteria same as primary!$REGULAR";
        exit 1;
    fi

    if [[ "$1" == "false" ]]; then
        sed -i "s/NESTED=$isNested/NESTED=false/" ~/.config/downganizer.conf
        sed -i "s/NESTED_CRITERIA=$nested/NESTED_CRITERIA=null/" ~/.config/downganizer.conf
        return;
    fi

    sed -i "s/NESTED=$isNested/NESTED=true/" ~/.config/downganizer.conf
    sed -i "s/NESTED_CRITERIA=$nested/NESTED_CRITERIA=$1/" ~/.config/downganizer.conf
    return;
}

set_dups() {
    dup=$(cat ~/.config/downganizer.conf | grep -m 1 "DUPLICATES=" | cut -d '=' -f2)
    if [[ "$dup" == "$1" ]]; then
        return;
    fi

    sed -i "s/DUPLICATES=$dup/DUPLICATES=$1/" ~/.config/downganizer.conf
}

